\subsection{Problem formulation}
\textbf{Goal}: compute the optimal charging/discharging schedule for a set of $m$ PEVs connected to the power grid.
\\\textbf{PEV charging constraints}
\begin{gather}
    -P^{dis,max}_p \leq P_{p,i} \leq P^{ch,max}_p, \quad \forall p,i \label{constr:c1}\\
    P_{p,i} = P^{ch}_{p,i}-P^{dis}_{p,i}, \quad \forall p,i \\
    \delta^{ch}_{p,i} P^{ch,min}_p \leq P^{ch}_{p,i} \leq \delta^{ch}_{p,i} P^{ch,max}_p, \quad \forall p,i \\
    \delta^{dis}_{p,i} P^{dis,min}_p \leq P^{dis}_{p,i} \leq \delta^{dis}_{p,i} P^{dis,max}_p, \quad \forall p,i \\
    \delta^{dis}_{p,i} + \delta^{ch}_{p,i} \leq 1, \quad \forall p,i \label{constr:c5}
\end{gather}
\\\textbf{Aggregated power constraints}
\begin{gather}
    P_i = \sum_{p=1}^m P_{p,i}, \quad \forall i \\
    P_i \leq P^{max}_i, \quad \forall i \label{constr:c7}
\end{gather}
\\\textbf{PEV state of charge evolution}\\
$\forall p,i:$
\begin{align}
    \begin{cases}
        x_{p,i+1} = x_{p,i} + T (\eta^{ch}_p P^{ch}_{p,i} - \frac{1}{\eta^{dis}_p} P^{dis}_{p,i}) \label{constr:c8}\\
        x_{p,t_0} = (x_0)_p
    \end{cases}
\end{align}
\\\textbf{PEV state of charge constraints}
\begin{gather}
    x_{p, F_p} = x^{ref}_p, \quad \forall p \\
    x^{min}_p \leq x_{p,i} \leq x^{max}_p, \quad \forall p,i \label{constr:c10}
\end{gather}
\\\textbf{Objective function to minimize} \\
\begin{align}
    V = \sum_{i=1}^{N} |P_i - P^{ref}_i|
\end{align}
that is possible to linearize, introducing the auxiliary variables $t_i$:
\begin{gather}
    V = \sum_{i=1}^{N} t_i \\
    s.t. \quad -t_i \leq P_i - P^{ref}_i \leq t_i, \quad \forall i \label{constr:c13}
\end{gather}
We then introduce a small perturbation term $\xi_{p,i}, \forall p,i$ in $V$ weighting the power to satisfy Assumption 2.4 of \autocite{VUJANIC2016144}. The final form of the objective function is the following:
\begin{align}
    V = \sum_{i=1}^{N} (t_i + \sum_{p=1}^m P_{p,i} \xi_{p,i}) \label{constr:c14}
\end{align}
\textbf{Charging/discharging schedule} \\
At each iteration of the MPC, the optimal control schedule is computed by solving
\begin{align}
    \begin{bmatrix}
        P^{ch}\\
        P^{dis} 
    \end{bmatrix}
    = \argmin_{P^{ch}, P^{dis}} V
\end{align}
subject to the constraints (\ref{constr:c1})-(\ref{constr:c10}), (\ref{constr:c13}), (\ref{constr:c14}),
\\and using the following notation:
$$P^{ch/dis} \triangleq \begin{bmatrix} 
    P^{ch/dis}_{1,1} & \dots & P^{ch/dis}_{1, N} \\
    \vdots & \ddots & \vdots \\
    P^{ch/dis}_{m,1} & \dots & P^{ch/dis}_{m, N}
\end{bmatrix}$$ 
The charging/discharging schedule of each PEV is:
$$P_p = \begin{bmatrix} P_{p,1} & \dots & P_{p, N} \end{bmatrix}^T = (P^{ch}_{p}-P^{dis}_{p})^T.$$